name: "AI Automation: Issue Triage"

on:
  issues:
    types: [opened, labeled]
  
  # Manual trigger
  workflow_dispatch:
    inputs:
      issue_number:
        description: "Issue number to triage"
        required: true
        type: number

# Only allow one issue-triage run at a time per repo
concurrency:
  group: ai-issue-triage-${{ github.repository }}
  cancel-in-progress: false

permissions:
  contents: write
  pull-requests: write
  issues: write
  actions: read
  id-token: write

jobs:
  triage:
    runs-on: ubuntu-latest
    # Only run on opened issues OR when 'claude' label is added OR manual dispatch
    if: |
      github.event_name == 'workflow_dispatch' ||
      github.event.action == 'opened' ||
      (github.event.action == 'labeled' && github.event.label.name == 'claude')
    
    steps:
      - name: Get issue details
        id: issue
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            ISSUE_NUMBER="${{ inputs.issue_number }}"
          else
            ISSUE_NUMBER="${{ github.event.issue.number }}"
          fi
          
          echo "number=$ISSUE_NUMBER" >> $GITHUB_OUTPUT
          
          # Get issue data
          gh issue view "$ISSUE_NUMBER" --repo "${{ github.repository }}" --json title,body,labels,author > /tmp/issue.json
          
          TITLE=$(jq -r '.title' /tmp/issue.json)
          BODY=$(jq -r '.body // "No description provided"' /tmp/issue.json)
          LABELS=$(jq -r '[.labels[].name] | join(",")' /tmp/issue.json)
          AUTHOR=$(jq -r '.author.login' /tmp/issue.json)
          
          echo "title=$TITLE" >> $GITHUB_OUTPUT
          echo "author=$AUTHOR" >> $GITHUB_OUTPUT
          echo "labels=$LABELS" >> $GITHUB_OUTPUT
          
          # Write body to file (multiline safe)
          echo "$BODY" > /tmp/issue_body.txt

      - name: Check queue and existing work
        id: check
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          REPO="${{ github.repository }}"
          ISSUE_NUMBER="${{ steps.issue.outputs.number }}"
          LABELS="${{ steps.issue.outputs.labels }}"
          
          echo "::group::Checking issue queue"
          
          # Ensure required labels exist
          gh label create "in-progress" --repo "$REPO" --description "AI is currently working on this" --color "fbca04" 2>/dev/null || true
          gh label create "queued" --repo "$REPO" --description "Waiting for AI to be available" --color "d4c5f9" 2>/dev/null || true
          gh label create "triaged" --repo "$REPO" --description "Issue has been triaged by AI" --color "c5def5" 2>/dev/null || true
          gh label create "ai-fix" --repo "$REPO" --description "Automated fix by AI" --color "0e8a16" 2>/dev/null || true
          
          # Skip issues created by other AI workflows (ci-fix, maintenance)
          if echo "$LABELS" | grep -qE "ai-fix|ai-maintenance|ci"; then
            echo "skip=true" >> $GITHUB_OUTPUT
            echo "reason=handled_by_other_workflow" >> $GITHUB_OUTPUT
            echo "Issue has AI workflow label - another workflow handles this"
            echo "::endgroup::"
            exit 0
          fi
          
          # Skip if already triaged
          if echo "$LABELS" | grep -q "triaged"; then
            echo "skip=true" >> $GITHUB_OUTPUT
            echo "reason=already_triaged" >> $GITHUB_OUTPUT
            echo "Issue already triaged"
            echo "::endgroup::"
            exit 0
          fi
          
          # Skip if this issue already has a linked PR
          LINKED_PRS=$(gh pr list --repo "$REPO" --search "linked:$ISSUE_NUMBER" --json number --jq 'length' 2>/dev/null || echo "0")
          if [ "$LINKED_PRS" -gt 0 ]; then
            echo "skip=true" >> $GITHUB_OUTPUT
            echo "reason=has_pr" >> $GITHUB_OUTPUT
            echo "Issue #$ISSUE_NUMBER already has a linked PR"
            echo "::endgroup::"
            exit 0
          fi
          
          # Check if another issue is currently being worked on
          IN_PROGRESS=$(gh issue list --repo "$REPO" --label "in-progress" --state open --json number --jq '.[0].number // empty')
          
          if [ -n "$IN_PROGRESS" ] && [ "$IN_PROGRESS" != "$ISSUE_NUMBER" ]; then
            echo "Another issue (#$IN_PROGRESS) is currently in progress"
            echo "Adding this issue to queue..."
            gh issue edit "$ISSUE_NUMBER" --repo "$REPO" --add-label "queued"
            echo "skip=true" >> $GITHUB_OUTPUT
            echo "reason=queued" >> $GITHUB_OUTPUT
            echo "::endgroup::"
            exit 0
          fi
          
          # This issue can proceed - mark as in-progress
          echo "No other issues in progress - proceeding with #$ISSUE_NUMBER"
          gh issue edit "$ISSUE_NUMBER" --repo "$REPO" --add-label "in-progress" --remove-label "queued" 2>/dev/null || true
          echo "skip=false" >> $GITHUB_OUTPUT
          echo "::endgroup::"

      - name: Checkout
        if: steps.check.outputs.skip != 'true'
        uses: actions/checkout@v6
        with:
          token: ${{ secrets.GH_PAT }}

      - name: Build prompt
        if: steps.check.outputs.skip != 'true'
        id: prompt
        env:
          ISSUE_NUMBER: ${{ steps.issue.outputs.number }}
          ISSUE_TITLE: ${{ steps.issue.outputs.title }}
          ISSUE_AUTHOR: ${{ steps.issue.outputs.author }}
        run: |
          ISSUE_BODY=$(cat /tmp/issue_body.txt)
          
          # Read prompt template
          PROMPT_TEMPLATE=$(cat .github/ai-automation/prompts/issue-triage.md)
          
          # Build full prompt with issue details
          DELIM="PROMPT_EOF_$(date +%s)"
          {
            echo "content<<$DELIM"
            echo "$PROMPT_TEMPLATE"
            echo ""
            echo "## Issue Details"
            echo ""
            echo "- **Issue:** #${ISSUE_NUMBER}"
            echo "- **Title:** ${ISSUE_TITLE}"
            echo "- **Author:** @${ISSUE_AUTHOR}"
            echo ""
            echo "**Description:**"
            echo "${ISSUE_BODY}"
            echo "$DELIM"
          } >> $GITHUB_OUTPUT

      - name: Run Claude
        if: steps.check.outputs.skip != 'true'
        id: claude
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ secrets.GH_PAT }}
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          show_full_output: true
          prompt: ${{ steps.prompt.outputs.content }}
          claude_args: "--model claude-opus-4-20250514 --max-turns 200 --allowedTools 'Bash(*),Read(*),Write(*),Edit(*),MultiEdit(*),Glob(*),Grep(*),GitHub(*)'"

      - name: Finalize issue labels
        if: always()
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          REPO="${{ github.repository }}"
          ISSUE_NUMBER="${{ steps.issue.outputs.number }}"
          
          # Remove in-progress label (work is done or failed)
          gh issue edit "$ISSUE_NUMBER" --repo "$REPO" --remove-label "in-progress" 2>/dev/null || true
          
          # Add triaged label if we actually processed it
          if [ "${{ steps.check.outputs.skip }}" != "true" ]; then
            gh issue edit "$ISSUE_NUMBER" --repo "$REPO" --add-label "triaged" 2>/dev/null || true
          fi
          
          # Trigger next queued issue if any
          NEXT_QUEUED=$(gh issue list --repo "$REPO" --label "queued" --state open --json number --jq 'sort_by(.number) | .[0].number // empty')
          if [ -n "$NEXT_QUEUED" ]; then
            echo "Triggering next queued issue: #$NEXT_QUEUED"
            gh workflow run ai-automation-issue-triage.yml --repo "$REPO" -f issue_number="$NEXT_QUEUED"
          fi
