name: "AI Automation: Issue Triage"

on:
  issues:
    types: [opened, labeled]
  
  # Manual trigger
  workflow_dispatch:
    inputs:
      issue_number:
        description: "Issue number to triage"
        required: true
        type: number

permissions:
  contents: write
  pull-requests: write
  issues: write
  actions: read
  id-token: write

jobs:
  triage:
    runs-on: ubuntu-latest
    # Only run on opened issues OR when 'claude' label is added OR manual dispatch
    if: |
      github.event_name == 'workflow_dispatch' ||
      github.event.action == 'opened' ||
      (github.event.action == 'labeled' && github.event.label.name == 'claude')
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_PAT }}

      - name: Get issue details
        id: issue
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            ISSUE_NUMBER="${{ inputs.issue_number }}"
          else
            ISSUE_NUMBER="${{ github.event.issue.number }}"
          fi
          
          echo "number=$ISSUE_NUMBER" >> $GITHUB_OUTPUT
          
          # Get issue data
          gh issue view "$ISSUE_NUMBER" --json title,body,labels,author > /tmp/issue.json
          
          TITLE=$(jq -r '.title' /tmp/issue.json)
          BODY=$(jq -r '.body // "No description provided"' /tmp/issue.json)
          LABELS=$(jq -r '[.labels[].name] | join(",")' /tmp/issue.json)
          AUTHOR=$(jq -r '.author.login' /tmp/issue.json)
          
          echo "title=$TITLE" >> $GITHUB_OUTPUT
          echo "author=$AUTHOR" >> $GITHUB_OUTPUT
          echo "labels=$LABELS" >> $GITHUB_OUTPUT
          
          # Write body to file (multiline safe)
          echo "$BODY" > /tmp/issue_body.txt

      - name: Check for existing implementation
        id: existing
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          ISSUE_NUMBER="${{ steps.issue.outputs.number }}"
          
          # Check if there's already a linked PR
          LINKED_PRS=$(gh pr list --search "linked:$ISSUE_NUMBER" --json number --jq 'length' 2>/dev/null || echo "0")
          
          if [ "$LINKED_PRS" -gt 0 ]; then
            echo "has_pr=true" >> $GITHUB_OUTPUT
            echo "Issue #$ISSUE_NUMBER already has a linked PR"
          else
            echo "has_pr=false" >> $GITHUB_OUTPUT
          fi
          
          # Check for triaged label
          LABELS="${{ steps.issue.outputs.labels }}"
          if echo "$LABELS" | grep -q "triaged"; then
            echo "already_triaged=true" >> $GITHUB_OUTPUT
            echo "Issue already triaged"
          else
            echo "already_triaged=false" >> $GITHUB_OUTPUT
          fi

      - name: Ensure labels exist
        if: steps.existing.outputs.already_triaged == 'false'
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          REPO="${{ github.repository }}"
          gh label create "triaged" --repo "$REPO" --description "Issue has been triaged by AI" --color "c5def5" 2>/dev/null || true
          gh label create "in-progress" --repo "$REPO" --description "Work in progress" --color "fbca04" 2>/dev/null || true
          gh label create "claude" --repo "$REPO" --description "Assigned to Claude AI" --color "7057ff" 2>/dev/null || true

      - name: Build prompt
        if: steps.existing.outputs.already_triaged == 'false'
        id: prompt
        env:
          ISSUE_NUMBER: ${{ steps.issue.outputs.number }}
          ISSUE_TITLE: ${{ steps.issue.outputs.title }}
          ISSUE_AUTHOR: ${{ steps.issue.outputs.author }}
        run: |
          ISSUE_BODY=$(cat /tmp/issue_body.txt)
          
          cat > /tmp/prompt.txt << 'PROMPT_HEREDOC'
          You are triaging and implementing a GitHub issue.

          ## Your Tasks

          1. **Analyze the issue** - understand what's being requested
          2. **Comment on the issue** with your analysis:
             - Summary (1-2 sentences)
             - Type: Bug fix / Feature / Enhancement / Documentation / Refactor / Question
             - Complexity: Low (< 1 hour) / Medium (1-4 hours) / High (4+ hours)
             - Implementation approach (2-3 sentences)
          
          3. **If implementable:**
             - Create a new branch named `claude/issue-ISSUE_NUMBER-short-desc`
             - Make the necessary code changes
             - Commit with a descriptive message
             - Push the branch
             - Create a draft PR linking to the issue with "Fixes #ISSUE_NUMBER" in the body
          
          4. **If not implementable** (needs clarification, question, too complex):
             - Just comment with your analysis and any questions

          Use `gh` CLI for GitHub operations. The repo is already checked out.

          PROMPT_HEREDOC
          
          # Append issue details
          cat >> /tmp/prompt.txt << DETAILS_HEREDOC
          
          ## Issue Details
          
          - **Issue:** #${ISSUE_NUMBER}
          - **Title:** ${ISSUE_TITLE}
          - **Author:** @${ISSUE_AUTHOR}
          
          **Description:**
          ${ISSUE_BODY}
          DETAILS_HEREDOC
          
          # Output for the action
          PROMPT_CONTENT=$(cat /tmp/prompt.txt)
          echo "content<<PROMPT_EOF" >> $GITHUB_OUTPUT
          echo "$PROMPT_CONTENT" >> $GITHUB_OUTPUT
          echo "PROMPT_EOF" >> $GITHUB_OUTPUT

      - name: Run Claude
        if: steps.existing.outputs.already_triaged == 'false'
        id: claude
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          show_full_output: true
          prompt: ${{ steps.prompt.outputs.content }}
          claude_args: "--max-turns 30 --allowedTools 'Bash(*),Read(*),Write(*),Edit(*),MultiEdit(*),Glob(*),Grep(*),GitHub(*)'"

      - name: Add triaged label
        if: steps.existing.outputs.already_triaged == 'false'
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          ISSUE_NUMBER="${{ steps.issue.outputs.number }}"
          gh issue edit "$ISSUE_NUMBER" --add-label "triaged" 2>/dev/null || true
