name: "AI Automation: Issue Triage"

on:
  issues:
    types: [opened, labeled]
  
  # Manual trigger
  workflow_dispatch:
    inputs:
      issue_number:
        description: "Issue number to triage"
        required: true
        type: number

permissions:
  contents: write
  pull-requests: write
  issues: write
  actions: read
  id-token: write

jobs:
  triage:
    runs-on: ubuntu-latest
    # Only run on opened issues OR when 'claude' label is added OR manual dispatch
    if: |
      github.event_name == 'workflow_dispatch' ||
      github.event.action == 'opened' ||
      (github.event.action == 'labeled' && github.event.label.name == 'claude')
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_PAT }}

      - name: Get issue details
        id: issue
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            ISSUE_NUMBER="${{ inputs.issue_number }}"
          else
            ISSUE_NUMBER="${{ github.event.issue.number }}"
          fi
          
          echo "number=$ISSUE_NUMBER" >> $GITHUB_OUTPUT
          
          # Get issue data
          gh issue view "$ISSUE_NUMBER" --json title,body,labels,author > /tmp/issue.json
          
          TITLE=$(jq -r '.title' /tmp/issue.json)
          BODY=$(jq -r '.body // "No description provided"' /tmp/issue.json)
          LABELS=$(jq -r '[.labels[].name] | join(",")' /tmp/issue.json)
          AUTHOR=$(jq -r '.author.login' /tmp/issue.json)
          
          echo "title=$TITLE" >> $GITHUB_OUTPUT
          echo "author=$AUTHOR" >> $GITHUB_OUTPUT
          echo "labels=$LABELS" >> $GITHUB_OUTPUT
          
          # Write body to file (can be multiline)
          echo "$BODY" > /tmp/issue_body.txt

      - name: Check for existing implementation
        id: existing
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          ISSUE_NUMBER="${{ steps.issue.outputs.number }}"
          
          # Check if there's already a linked PR
          LINKED_PRS=$(gh pr list --search "linked:issue:$ISSUE_NUMBER" --json number --jq 'length')
          
          if [ "$LINKED_PRS" -gt 0 ]; then
            echo "has_pr=true" >> $GITHUB_OUTPUT
            echo "Issue #$ISSUE_NUMBER already has a linked PR"
          else
            echo "has_pr=false" >> $GITHUB_OUTPUT
          fi
          
          # Check if claude has already commented
          CLAUDE_COMMENTS=$(gh issue view "$ISSUE_NUMBER" --json comments --jq '[.comments[] | select(.author.login == "github-actions" or .author.login == "github-actions[bot]")] | length')
          
          if [ "$CLAUDE_COMMENTS" -gt 0 ]; then
            echo "already_triaged=true" >> $GITHUB_OUTPUT
          else
            echo "already_triaged=false" >> $GITHUB_OUTPUT
          fi

      - name: Setup Claude Code
        if: steps.existing.outputs.already_triaged == 'false'
        uses: anthropics/claude-code-action@beta
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}

      - name: Triage and expand issue
        if: steps.existing.outputs.already_triaged == 'false'
        id: triage
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
          ISSUE_NUMBER: ${{ steps.issue.outputs.number }}
          ISSUE_TITLE: ${{ steps.issue.outputs.title }}
          ISSUE_AUTHOR: ${{ steps.issue.outputs.author }}
        run: |
          ISSUE_BODY=$(cat /tmp/issue_body.txt)
          
          # Build prompt for Claude
          PROMPT=$(cat <<'PROMPT_END'
          You are triaging a GitHub issue. Analyze it and provide:

          1. **Summary**: A clear 1-2 sentence summary of what's being requested
          2. **Type**: Bug fix, Feature, Enhancement, Documentation, Refactor, or Question
          3. **Complexity**: Low (< 1 hour), Medium (1-4 hours), High (4+ hours), or Unknown
          4. **Affected areas**: Which files/modules likely need changes
          5. **Implementation approach**: Brief technical approach (2-3 sentences)
          6. **Questions** (if any): What clarifications would help?

          Then, if this looks implementable:
          - Create a branch and implement the fix/feature
          - Open a draft PR linking to this issue
          - Comment on the issue with your analysis and link to the PR

          If it's a question or needs clarification, just comment with helpful information.

          Issue #$ISSUE_NUMBER: $ISSUE_TITLE
          Author: @$ISSUE_AUTHOR
          
          Description:
          $ISSUE_BODY
          PROMPT_END
          )
          
          # Let Claude do its thing
          claude -p "$PROMPT" --allowedTools "Bash,GitHub,Read,Write,Edit" 2>&1 | tee /tmp/claude_output.txt
          
          # Check if a PR was created
          sleep 2
          NEW_PR=$(gh pr list --author "@me" --search "head:claude/" --json number,title --jq '.[0].number // empty')
          
          if [ -n "$NEW_PR" ]; then
            echo "pr_created=true" >> $GITHUB_OUTPUT
            echo "pr_number=$NEW_PR" >> $GITHUB_OUTPUT
          else
            echo "pr_created=false" >> $GITHUB_OUTPUT
          fi

      - name: Add labels based on triage
        if: steps.existing.outputs.already_triaged == 'false'
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          ISSUE_NUMBER="${{ steps.issue.outputs.number }}"
          
          # Add 'triaged' label to mark this issue as processed
          gh issue edit "$ISSUE_NUMBER" --add-label "triaged" 2>/dev/null || true
          
          # If we created a PR, add 'in-progress' label
          if [ "${{ steps.triage.outputs.pr_created }}" = "true" ]; then
            gh issue edit "$ISSUE_NUMBER" --add-label "in-progress" 2>/dev/null || true
          fi
