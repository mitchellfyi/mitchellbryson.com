name: Generate News

on:
  schedule:
    - cron: '0 8 * * *' # Daily at 8am UTC
  workflow_dispatch:
    inputs:
      mode:
        description: 'Override mode (editorial or digest)'
        required: false
        type: choice
        options:
          - auto
          - editorial
          - digest

concurrency:
  group: generate-news
  cancel-in-progress: false

permissions:
  contents: write
  pull-requests: write

jobs:
  generate:
    name: Generate News
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Determine mode
        id: mode
        run: |
          if [ "${{ github.event.inputs.mode }}" != "" ] && [ "${{ github.event.inputs.mode }}" != "auto" ]; then
            echo "mode=${{ github.event.inputs.mode }}" >> "$GITHUB_OUTPUT"
          else
            DOW=$(date -u +%u)
            if [ "$DOW" = "5" ]; then
              echo "mode=digest" >> "$GITHUB_OUTPUT"
            else
              echo "mode=editorial" >> "$GITHUB_OUTPUT"
            fi
          fi

      - name: Debug - workflow context
        run: |
          echo "=== Workflow Context ==="
          echo "Event: ${{ github.event_name }}"
          echo "Mode: ${{ steps.mode.outputs.mode }}"
          echo "Ref: ${{ github.ref }}"
          echo "SHA: ${{ github.sha }}"
          echo "Run ID: ${{ github.run_id }}"
          echo "Timestamp: $(date -u '+%Y-%m-%dT%H:%M:%SZ')"

      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1
        with:
          token: ${{ secrets.GH_PAT }}

      - name: Setup Node
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        with:
          node-version: 22
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Generate news
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          NEWS_MODE: ${{ steps.mode.outputs.mode }}
        run: node scripts/generate-news/index.mjs

      - name: Debug - generated files
        if: always()
        continue-on-error: true
        run: |
          echo "=== Generated file check ==="
          if [ -f /tmp/news-slugs.txt ]; then
            echo "Slugs:"
            cat /tmp/news-slugs.txt
            echo ""
            echo "Titles:"
            cat /tmp/news-titles.txt
          else
            echo "No slug file found â€” generation may have failed"
            cat /tmp/news-generation/manifest.json 2>/dev/null || echo "(no manifest)"
          fi

      - name: Upload manifest artifact
        if: always()
        continue-on-error: true
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: news-manifest
          retention-days: 30
          path: |
            src/app/news/*/manifest.json
            /tmp/news-generation/manifest.json

      - name: Create Pull Request
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          DATE=$(cat /tmp/news-date.txt)
          FIRST_SLUG=$(head -1 /tmp/news-slugs.txt)

          echo "=== Creating PR ==="
          echo "Date: ${DATE}"
          echo "Mode: ${{ steps.mode.outputs.mode }}"

          BRANCH="news/${DATE}"
          echo "Branch: ${BRANCH}"

          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          # Delete remote branch if it exists (from a previous failed run)
          git push origin --delete "${BRANCH}" 2>/dev/null || true

          git checkout -b "${BRANCH}"

          # Stage all new news files
          while IFS= read -r slug; do
            git add "src/app/news/${slug}/"
            echo "Staged: src/app/news/${slug}/"
          done < /tmp/news-slugs.txt

          # Stage any OG images
          git add public/images/news/ 2>/dev/null || true

          # Stage any cross-linked articles/news
          if [ -f /tmp/cross-linked-news.txt ]; then
            while IFS= read -r filepath; do
              git add "${filepath}"
              echo "Staged cross-linked: ${filepath}"
            done < /tmp/cross-linked-news.txt
          fi

          git status

          echo "Daily news: ${DATE}" > /tmp/commit-msg.txt
          git commit -F /tmp/commit-msg.txt

          git push origin "${BRANCH}"

          # Render PR body
          node scripts/generate-news/render-pr-body.mjs "${FIRST_SLUG}"

          PR_URL=$(gh pr create \
            --title "Daily news: ${DATE}" \
            --body-file /tmp/pr-body.md)

          echo "PR created: ${PR_URL}"

          gh pr merge "${PR_URL}" --squash --delete-branch
          echo "PR merged successfully"
