name: "AI Automation: Copilot Bootstrap"

# This workflow handles Copilot PRs that need workflow approval
# It approves pending workflows, waits for Copilot to finish, then triggers PR handler

on:
  pull_request:
    types: [opened, synchronize, ready_for_review]
  
  # Also trigger when review is requested (Copilot requests review when done)
  pull_request_target:
    types: [review_requested]

permissions:
  contents: read
  pull-requests: write
  actions: write

jobs:
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Job 1: Approve workflow runs for Copilot PRs
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  approve-copilot-workflows:
    if: |
      github.event.pull_request.user.login == 'copilot-swe-agent[bot]' ||
      contains(github.event.pull_request.head.ref, 'copilot/')
    runs-on: ubuntu-latest
    steps:
      - name: Wait for workflow runs to appear
        run: |
          echo "Waiting for workflow runs to be queued..."
          sleep 15

      - name: Approve pending workflow runs
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          PR_NUM="${{ github.event.pull_request.number }}"
          REPO="${{ github.repository }}"
          HEAD_SHA="${{ github.event.pull_request.head.sha }}"
          
          echo "::group::Approving workflows for Copilot PR #$PR_NUM"
          echo "HEAD SHA: $HEAD_SHA"
          
          # Get all workflow runs for this commit that need approval
          PENDING_RUNS=$(gh api repos/$REPO/actions/runs \
            --jq ".workflow_runs[] | select(.head_sha == \"$HEAD_SHA\" and .status == \"action_required\") | .id" 2>/dev/null || echo "")
          
          if [ -z "$PENDING_RUNS" ]; then
            echo "No pending workflow runs to approve"
          else
            for RUN_ID in $PENDING_RUNS; do
              echo "Approving workflow run $RUN_ID..."
              gh api repos/$REPO/actions/runs/$RUN_ID/approve -X POST \
                && echo "âœ“ Approved run $RUN_ID" \
                || echo "âœ— Could not approve run $RUN_ID (may already be approved)"
            done
          fi
          echo "::endgroup::"

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Job 2: Handle when Copilot requests review (signals it's done)
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  handle-copilot-ready:
    if: |
      github.event_name == 'pull_request_target' &&
      github.event.action == 'review_requested' &&
      (github.event.pull_request.user.login == 'copilot-swe-agent[bot]' ||
       contains(github.event.pull_request.head.ref, 'copilot/'))
    runs-on: ubuntu-latest
    steps:
      - name: Check if review requested from mitchellfyi
        id: check
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          PR_NUM="${{ github.event.pull_request.number }}"
          REPO="${{ github.repository }}"
          
          echo "::group::Checking review request"
          REQUESTED=$(gh pr view $PR_NUM --repo $REPO --json reviewRequests --jq '.reviewRequests[].login' 2>/dev/null || echo "")
          echo "Review requested from: $REQUESTED"
          
          if echo "$REQUESTED" | grep -q "mitchellfyi"; then
            echo "Review requested from mitchellfyi - Copilot is done!"
            echo "ready=true" >> $GITHUB_OUTPUT
          else
            echo "Review not requested from mitchellfyi yet"
            echo "ready=false" >> $GITHUB_OUTPUT
          fi
          echo "::endgroup::"

      - name: Mark PR as ready for review
        if: steps.check.outputs.ready == 'true'
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          PR_NUM="${{ github.event.pull_request.number }}"
          REPO="${{ github.repository }}"
          
          echo "::group::Marking PR ready for review"
          IS_DRAFT=$(gh pr view $PR_NUM --repo $REPO --json isDraft --jq '.isDraft')
          
          if [ "$IS_DRAFT" == "true" ]; then
            echo "PR is draft - marking as ready..."
            gh pr ready $PR_NUM --repo $REPO \
              && echo "âœ“ PR marked as ready for review" \
              || echo "âœ— Could not mark PR ready"
          else
            echo "PR is already ready for review"
          fi
          echo "::endgroup::"

      - name: Add ai-fix label to trigger PR handler
        if: steps.check.outputs.ready == 'true'
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          PR_NUM="${{ github.event.pull_request.number }}"
          REPO="${{ github.repository }}"
          
          echo "Adding ai-fix label to trigger PR handler workflow..."
          gh pr edit $PR_NUM --repo $REPO --add-label "ai-fix" \
            || echo "Label may already exist or could not be added"

      - name: Comment to confirm automation activated
        if: steps.check.outputs.ready == 'true'
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          PR_NUM="${{ github.event.pull_request.number }}"
          REPO="${{ github.repository }}"
          
          gh pr comment $PR_NUM --repo $REPO --body "ðŸ¤– **Copilot Bootstrap Complete**

Copilot has finished working on this PR. Automation activated:
- âœ… Workflow runs approved
- âœ… PR marked as ready for review  
- âœ… AI automation label added

The PR Handler will now:
1. Wait for CI to complete
2. Request code review if needed
3. Auto-merge when approved"
