name: "AI Automation: Copilot Bootstrap"

# This workflow handles Copilot PRs that need workflow approval and automation
# Triggers on push to copilot/* branches (more reliable than review_requested for bots)

on:
  push:
    branches:
      - 'copilot/**'
      - 'copilot/*'
  
  pull_request:
    types: [opened, synchronize]
    branches:
      - main

permissions:
  contents: read
  pull-requests: write
  actions: write

jobs:
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Job 1: Approve workflow runs for Copilot PRs
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  approve-copilot-workflows:
    if: |
      (github.event_name == 'pull_request' &&
       (github.event.pull_request.user.login == 'copilot-swe-agent[bot]' ||
        startsWith(github.event.pull_request.head.ref, 'copilot/'))) ||
      (github.event_name == 'push' &&
       startsWith(github.ref_name, 'copilot/'))
    runs-on: ubuntu-latest
    steps:
      - name: Wait for workflow runs to appear
        run: |
          echo "Waiting for workflow runs to be queued..."
          sleep 15

      - name: Approve pending workflow runs
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          REPO="${{ github.repository }}"
          
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            HEAD_SHA="${{ github.event.pull_request.head.sha }}"
          else
            HEAD_SHA="${{ github.sha }}"
          fi
          
          echo "::group::Approving workflows for commit $HEAD_SHA"
          
          # Get all workflow runs for this commit that need approval
          PENDING_RUNS=$(gh api repos/$REPO/actions/runs \
            --jq ".workflow_runs[] | select(.head_sha == \"$HEAD_SHA\" and .status == \"action_required\") | .id" 2>/dev/null || echo "")
          
          if [ -z "$PENDING_RUNS" ]; then
            echo "No pending workflow runs to approve"
          else
            for RUN_ID in $PENDING_RUNS; do
              echo "Approving workflow run $RUN_ID..."
              gh api repos/$REPO/actions/runs/$RUN_ID/approve -X POST \
                && echo "âœ“ Approved run $RUN_ID" \
                || echo "âœ— Could not approve run $RUN_ID (may already be approved)"
            done
          fi
          echo "::endgroup::"

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Job 2: Check if Copilot is done and mark PR ready
  # Triggered by push to copilot/* branches - polls for review request
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  handle-copilot-ready:
    if: |
      github.event_name == 'push' &&
      startsWith(github.ref_name, 'copilot/')
    runs-on: ubuntu-latest
    steps:
      - name: Find PR and check if Copilot is done
        id: check
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          REPO="${{ github.repository }}"
          BRANCH="${{ github.ref_name }}"
          
          echo "::group::Checking Copilot PR status"
          echo "Branch: $BRANCH"
          
          # Find open PR for this branch
          PR_JSON=$(gh pr list --repo "$REPO" --head "$BRANCH" --state open --json number,isDraft,title,reviewRequests --jq '.[0] // empty')
          
          if [ -z "$PR_JSON" ]; then
            echo "No open PR found for branch $BRANCH"
            echo "ready=false" >> $GITHUB_OUTPUT
            echo "::endgroup::"
            exit 0
          fi
          
          PR_NUM=$(echo "$PR_JSON" | jq -r '.number')
          IS_DRAFT=$(echo "$PR_JSON" | jq -r '.isDraft')
          
          echo "Found PR #$PR_NUM (draft: $IS_DRAFT)"
          
          # Check if review requested from mitchellfyi (Copilot's signal that it's done)
          REQUESTED=$(echo "$PR_JSON" | jq -r '.reviewRequests[].login' 2>/dev/null || echo "")
          echo "Review requested from: ${REQUESTED:-none}"
          
          if echo "$REQUESTED" | grep -q "mitchellfyi"; then
            echo "âœ“ Copilot has requested review from mitchellfyi - it's done!"
            echo "ready=true" >> $GITHUB_OUTPUT
            echo "pr_number=$PR_NUM" >> $GITHUB_OUTPUT
            echo "is_draft=$IS_DRAFT" >> $GITHUB_OUTPUT
          else
            echo "Review not yet requested from mitchellfyi - Copilot still working"
            echo "ready=false" >> $GITHUB_OUTPUT
          fi
          echo "::endgroup::"

      - name: Mark PR as ready for review
        if: steps.check.outputs.ready == 'true' && steps.check.outputs.is_draft == 'true'
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          PR_NUM="${{ steps.check.outputs.pr_number }}"
          REPO="${{ github.repository }}"
          
          echo "Marking PR #$PR_NUM as ready for review..."
          gh pr ready $PR_NUM --repo $REPO \
            && echo "âœ“ PR marked as ready for review" \
            || echo "âœ— Could not mark PR ready (may already be ready)"

      - name: Add ai-fix label to trigger PR handler
        if: steps.check.outputs.ready == 'true'
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          PR_NUM="${{ steps.check.outputs.pr_number }}"
          REPO="${{ github.repository }}"
          
          echo "Adding ai-fix label to trigger PR handler workflow..."
          gh pr edit $PR_NUM --repo $REPO --add-label "ai-fix" 2>/dev/null \
            || gh api repos/$REPO/issues/$PR_NUM/labels -f labels[]="ai-fix" 2>/dev/null \
            || echo "Label may already exist or could not be added"

      - name: Comment to confirm automation activated
        if: steps.check.outputs.ready == 'true'
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          PR_NUM="${{ steps.check.outputs.pr_number }}"
          REPO="${{ github.repository }}"
          
          # Check if we already commented (avoid duplicates)
          EXISTING=$(gh api repos/$REPO/issues/$PR_NUM/comments --jq '[.[] | select(.body | contains("Copilot Bootstrap Complete"))] | length' 2>/dev/null || echo "0")
          
          if [ "$EXISTING" -gt 0 ]; then
            echo "Already commented on this PR - skipping"
            exit 0
          fi
          
          gh pr comment $PR_NUM --repo $REPO --body "ðŸ¤– **Copilot Bootstrap Complete**

Copilot has finished working on this PR. Automation activated:
- âœ… Workflow runs approved
- âœ… PR marked as ready for review  
- âœ… AI automation label added

The PR Handler will now:
1. Wait for CI to complete
2. Request code review if needed
3. Auto-merge when approved"
