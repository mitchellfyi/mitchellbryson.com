name: "AI Automation: Copilot Bootstrap"

# This workflow handles Copilot PRs:
# - Approves pending workflow runs
# - Marks PR ready when Copilot finishes
# - Detects merge conflicts and asks Copilot to fix them

on:
  push:
    branches:
      - 'copilot/**'
      - 'copilot/*'
  
  pull_request:
    types: [opened, synchronize]
    branches:
      - main

  # Check for conflicts when main changes
  workflow_run:
    workflows:
      - CI
    types:
      - completed
    branches:
      - main

permissions:
  contents: read
  pull-requests: write
  actions: write

jobs:
  # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  # Job 1: Approve workflow runs for Copilot PRs
  # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  approve-copilot-workflows:
    if: |
      (github.event_name == 'pull_request' &&
       (github.event.pull_request.user.login == 'copilot-swe-agent[bot]' ||
        startsWith(github.event.pull_request.head.ref, 'copilot/'))) ||
      (github.event_name == 'push' &&
       startsWith(github.ref_name, 'copilot/'))
    runs-on: ubuntu-latest
    steps:
      - name: Wait for workflow runs to appear
        run: |
          echo "Waiting for workflow runs to be queued..."
          sleep 15

      - name: Approve pending workflow runs
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          REPO="${{ github.repository }}"
          
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            HEAD_SHA="${{ github.event.pull_request.head.sha }}"
          else
            HEAD_SHA="${{ github.sha }}"
          fi
          
          echo "::group::Approving workflows for commit $HEAD_SHA"
          
          PENDING_RUNS=$(gh api repos/$REPO/actions/runs \
            --jq ".workflow_runs[] | select(.head_sha == \"$HEAD_SHA\" and .status == \"action_required\") | .id" 2>/dev/null || echo "")
          
          if [ -z "$PENDING_RUNS" ]; then
            echo "No pending workflow runs to approve"
          else
            for RUN_ID in $PENDING_RUNS; do
              echo "Approving workflow run $RUN_ID..."
              gh api repos/$REPO/actions/runs/$RUN_ID/approve -X POST \
                && echo "‚úì Approved run $RUN_ID" \
                || echo "‚úó Could not approve run $RUN_ID"
            done
          fi
          echo "::endgroup::"

  # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  # Job 2: Check if Copilot is done and mark PR ready
  # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  handle-copilot-ready:
    if: |
      github.event_name == 'push' &&
      startsWith(github.ref_name, 'copilot/')
    runs-on: ubuntu-latest
    steps:
      - name: Find PR and check if Copilot is done
        id: check
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          REPO="${{ github.repository }}"
          BRANCH="${{ github.ref_name }}"
          
          echo "::group::Checking Copilot PR status"
          echo "Branch: $BRANCH"
          
          PR_JSON=$(gh pr list --repo "$REPO" --head "$BRANCH" --state open --json number,isDraft,title,reviewRequests --jq '.[0] // empty')
          
          if [ -z "$PR_JSON" ]; then
            echo "No open PR found for branch $BRANCH"
            echo "ready=false" >> $GITHUB_OUTPUT
            echo "::endgroup::"
            exit 0
          fi
          
          PR_NUM=$(echo "$PR_JSON" | jq -r '.number')
          IS_DRAFT=$(echo "$PR_JSON" | jq -r '.isDraft')
          
          echo "Found PR #$PR_NUM (draft: $IS_DRAFT)"
          
          REQUESTED=$(echo "$PR_JSON" | jq -r '.reviewRequests[].login' 2>/dev/null || echo "")
          echo "Review requested from: ${REQUESTED:-none}"
          
          if echo "$REQUESTED" | grep -q "mitchellfyi"; then
            echo "‚úì Copilot has requested review - it's done!"
            echo "ready=true" >> $GITHUB_OUTPUT
            echo "pr_number=$PR_NUM" >> $GITHUB_OUTPUT
            echo "is_draft=$IS_DRAFT" >> $GITHUB_OUTPUT
          else
            echo "Review not yet requested - Copilot still working"
            echo "ready=false" >> $GITHUB_OUTPUT
          fi
          echo "::endgroup::"

      - name: Mark PR as ready for review
        if: steps.check.outputs.ready == 'true' && steps.check.outputs.is_draft == 'true'
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          PR_NUM="${{ steps.check.outputs.pr_number }}"
          REPO="${{ github.repository }}"
          
          echo "Marking PR #$PR_NUM as ready for review..."
          gh pr ready $PR_NUM --repo $REPO \
            && echo "‚úì PR marked as ready for review" \
            || echo "‚úó Could not mark PR ready"

      - name: Add ai-fix label
        if: steps.check.outputs.ready == 'true'
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          PR_NUM="${{ steps.check.outputs.pr_number }}"
          REPO="${{ github.repository }}"
          
          gh pr edit $PR_NUM --repo $REPO --add-label "ai-fix" 2>/dev/null \
            || gh api repos/$REPO/issues/$PR_NUM/labels -f labels[]="ai-fix" 2>/dev/null \
            || true

      - name: Comment to confirm automation activated
        if: steps.check.outputs.ready == 'true'
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          PR_NUM="${{ steps.check.outputs.pr_number }}"
          REPO="${{ github.repository }}"
          
          EXISTING=$(gh api repos/$REPO/issues/$PR_NUM/comments --jq '[.[] | select(.body | contains("Copilot Bootstrap Complete"))] | length' 2>/dev/null || echo "0")
          
          if [ "$EXISTING" -gt 0 ]; then
            echo "Already commented - skipping"
            exit 0
          fi
          
          gh pr comment $PR_NUM --repo $REPO --body "ü§ñ **Copilot Bootstrap Complete**

Copilot has finished working on this PR. Automation activated:
- ‚úÖ Workflow runs approved
- ‚úÖ PR marked as ready for review  
- ‚úÖ AI automation label added

The PR Handler will now:
1. Wait for CI to complete
2. Request code review if needed
3. Auto-merge when approved"

  # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  # Job 3: Check for merge conflicts on Copilot PRs and ask Copilot to fix
  # Runs on push to copilot branches AND when main changes (workflow_run)
  # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  check-conflicts:
    if: |
      (github.event_name == 'push' && startsWith(github.ref_name, 'copilot/')) ||
      (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success')
    runs-on: ubuntu-latest
    steps:
      - name: Find Copilot PRs with conflicts
        id: find
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          REPO="${{ github.repository }}"
          
          echo "::group::Checking for conflicting Copilot PRs"
          
          if [ "${{ github.event_name }}" = "push" ]; then
            # Check just this branch's PR
            BRANCH="${{ github.ref_name }}"
            PRS=$(gh pr list --repo "$REPO" --head "$BRANCH" --state open --json number,headRefName --jq '.[].number' || echo "")
          else
            # Main changed - check all copilot/* PRs
            PRS=$(gh pr list --repo "$REPO" --state open --json number,headRefName \
              --jq '.[] | select(.headRefName | startswith("copilot/")) | .number' || echo "")
          fi
          
          if [ -z "$PRS" ]; then
            echo "No Copilot PRs to check"
            echo "conflicting_prs=" >> $GITHUB_OUTPUT
            echo "::endgroup::"
            exit 0
          fi
          
          CONFLICTING=""
          for PR_NUM in $PRS; do
            echo "Checking PR #$PR_NUM..."
            
            # Get mergeable status (may need a moment to compute)
            sleep 2
            MERGEABLE=$(gh api repos/$REPO/pulls/$PR_NUM --jq '.mergeable // "unknown"' 2>/dev/null || echo "unknown")
            MERGEABLE_STATE=$(gh api repos/$REPO/pulls/$PR_NUM --jq '.mergeable_state // "unknown"' 2>/dev/null || echo "unknown")
            
            echo "  mergeable: $MERGEABLE, state: $MERGEABLE_STATE"
            
            if [ "$MERGEABLE" = "false" ] || [ "$MERGEABLE_STATE" = "dirty" ]; then
              echo "  ‚ö†Ô∏è PR #$PR_NUM has conflicts!"
              CONFLICTING="$CONFLICTING $PR_NUM"
            fi
          done
          
          echo "conflicting_prs=$CONFLICTING" >> $GITHUB_OUTPUT
          echo "::endgroup::"

      - name: Ask Copilot to fix conflicts
        if: steps.find.outputs.conflicting_prs != ''
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          REPO="${{ github.repository }}"
          
          for PR_NUM in ${{ steps.find.outputs.conflicting_prs }}; do
            echo "::group::Asking Copilot to fix PR #$PR_NUM"
            
            # Check if we already asked recently (avoid spam)
            RECENT_ASK=$(gh api repos/$REPO/issues/$PR_NUM/comments \
              --jq '[.[] | select(.body | contains("merge conflict") and contains("@copilot"))] | sort_by(.created_at) | last | .created_at // ""' 2>/dev/null || echo "")
            
            if [ -n "$RECENT_ASK" ]; then
              # Check if ask was within last hour
              ASK_TIME=$(date -d "$RECENT_ASK" +%s 2>/dev/null || echo "0")
              NOW=$(date +%s)
              AGE=$((NOW - ASK_TIME))
              
              if [ "$AGE" -lt 3600 ]; then
                echo "Already asked Copilot within the last hour - skipping"
                echo "::endgroup::"
                continue
              fi
            fi
            
            # Get conflicting files if possible
            CONFLICTS=$(gh api repos/$REPO/pulls/$PR_NUM --jq '.mergeable_state' 2>/dev/null || echo "unknown")
            
            gh pr comment $PR_NUM --repo $REPO --body "‚ö†Ô∏è **Merge Conflict Detected**

This PR has a merge conflict with the \`main\` branch.

@copilot Please resolve by merging main and fixing conflicts:

\`\`\`bash
git fetch origin main
git merge origin/main
\`\`\`

This will create conflict markers. Edit the conflicting files to resolve them (look for \`<<<<<<<\`, \`=======\`, \`>>>>>>>\` markers), then commit:

\`\`\`bash
git add .
git commit -m 'fix: Merge main and resolve conflicts'
\`\`\`

Common conflict files: \`config/routes.rb\`, \`db/schema.rb\`, \`app/views/layouts/application.html.erb\`"
            
            echo "‚úì Asked Copilot to fix conflicts on PR #$PR_NUM"
            echo "::endgroup::"
          done
