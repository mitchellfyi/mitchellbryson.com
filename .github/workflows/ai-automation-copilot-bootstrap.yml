name: "AI Automation: Copilot Bootstrap"

# Handles Copilot PRs:
# - Marks PR ready when Copilot finishes (requests review)
# - Adds ai-fix label to trigger PR handler
# - Also triggers for ai/* branches (Claude-created fix branches)

on:
  push:
    branches:
      - 'copilot/**'
      - 'copilot/*'
      - 'ai/**'
      - 'ai/*'

permissions:
  contents: read
  pull-requests: write

jobs:
  handle-copilot-ready:
    runs-on: ubuntu-latest
    steps:
      - name: Find PR and check if Copilot is done
        id: check
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          REPO="${{ github.repository }}"
          BRANCH="${{ github.ref_name }}"
          
          echo "::group::Checking Copilot PR status"
          echo "Branch: $BRANCH"
          
          PR_JSON=$(gh pr list --repo "$REPO" --head "$BRANCH" --state open --json number,isDraft,title,reviewRequests --jq '.[0] // empty')
          
          if [ -z "$PR_JSON" ]; then
            echo "No open PR found for branch $BRANCH"
            echo "ready=false" >> $GITHUB_OUTPUT
            echo "::endgroup::"
            exit 0
          fi
          
          PR_NUM=$(echo "$PR_JSON" | jq -r '.number')
          IS_DRAFT=$(echo "$PR_JSON" | jq -r '.isDraft')
          
          echo "Found PR #$PR_NUM (draft: $IS_DRAFT)"
          
          REQUESTED=$(echo "$PR_JSON" | jq -r '.reviewRequests[].login' 2>/dev/null || echo "")
          echo "Review requested from: ${REQUESTED:-none}"
          
          if echo "$REQUESTED" | grep -q "mitchellfyi"; then
            echo "âœ“ Copilot has requested review - it's done!"
            echo "ready=true" >> $GITHUB_OUTPUT
            echo "pr_number=$PR_NUM" >> $GITHUB_OUTPUT
            echo "is_draft=$IS_DRAFT" >> $GITHUB_OUTPUT
          else
            echo "Review not yet requested - Copilot still working"
            echo "ready=false" >> $GITHUB_OUTPUT
          fi
          echo "::endgroup::"

      - name: Mark PR as ready for review
        if: steps.check.outputs.ready == 'true' && steps.check.outputs.is_draft == 'true'
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          PR_NUM="${{ steps.check.outputs.pr_number }}"
          REPO="${{ github.repository }}"
          
          echo "Marking PR #$PR_NUM as ready for review..."
          gh pr ready $PR_NUM --repo $REPO \
            && echo "âœ“ PR marked as ready for review" \
            || echo "âœ— Could not mark PR ready"

      - name: Add ai-fix label
        if: steps.check.outputs.ready == 'true'
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          PR_NUM="${{ steps.check.outputs.pr_number }}"
          REPO="${{ github.repository }}"
          
          gh pr edit $PR_NUM --repo $REPO --add-label "ai-fix" 2>/dev/null \
            || gh api repos/$REPO/issues/$PR_NUM/labels -f labels[]="ai-fix" 2>/dev/null \
            || true

      - name: Comment to confirm automation
        if: steps.check.outputs.ready == 'true'
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          PR_NUM="${{ steps.check.outputs.pr_number }}"
          REPO="${{ github.repository }}"
          
          EXISTING=$(gh api repos/$REPO/issues/$PR_NUM/comments --jq '[.[] | select(.body | contains("Copilot Bootstrap Complete"))] | length' 2>/dev/null || echo "0")
          
          if [ "$EXISTING" -gt 0 ]; then
            echo "Already commented - skipping"
            exit 0
          fi
          
          BODY="ðŸ¤– **Copilot Bootstrap Complete**"
          BODY="${BODY}"$'\n\n'"Copilot has finished. The PR Handler will now:"
          BODY="${BODY}"$'\n'"â€¢ Wait for CI to complete"
          BODY="${BODY}"$'\n'"â€¢ Request code review if needed"
          BODY="${BODY}"$'\n'"â€¢ Auto-merge when approved"
          
          gh pr comment $PR_NUM --repo $REPO --body "$BODY"
