name: Self-Healing CI

on:
  workflow_run:
    workflows: ["CI"]
    branches: [main]
    types: [completed]

permissions:
  contents: write
  pull-requests: write
  actions: read
  checks: read

jobs:
  create-fix-pr:
    name: Create Fix PR for Copilot
    runs-on: ubuntu-latest
    if: github.event.workflow_run.conclusion == 'failure'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.MITCHELL_PAT }}
          fetch-depth: 0

      - name: Get failure details
        id: failure
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const runId = context.payload.workflow_run.id;
            const sha = context.payload.workflow_run.head_sha;
            const shortSha = sha.substring(0, 7);

            // Get failed jobs
            const jobs = await github.rest.actions.listJobsForWorkflowRun({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: runId
            });
            const failedJobs = jobs.data.jobs.filter(job => job.conclusion === 'failure');

            if (failedJobs.length === 0) {
              core.setOutput('skip', 'true');
              return;
            }

            // Get logs - just the last 80 lines of each failed job
            const jobLogs = [];
            for (const job of failedJobs) {
              try {
                const logs = await github.rest.actions.downloadJobLogsForWorkflowRun({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  job_id: job.id
                });
                const logLines = logs.data.split('\n');
                // Take only last 80 lines to keep it manageable
                const relevantLines = logLines.slice(-80).join('\n');
                jobLogs.push({ name: job.name, log: relevantLines });
              } catch (error) {
                jobLogs.push({ name: job.name, log: 'Failed to fetch logs' });
              }
            }

            const result = {
              sha,
              shortSha,
              runUrl: context.payload.workflow_run.html_url,
              failedJobs: failedJobs.map(j => j.name),
              jobLogs
            };

            // Write to file to avoid shell escaping issues
            fs.writeFileSync('/tmp/failure-details.json', JSON.stringify(result, null, 2));

            core.setOutput('skip', 'false');
            core.setOutput('short_sha', shortSha);
            core.setOutput('sha', sha);
            core.setOutput('run_url', context.payload.workflow_run.html_url);

      - name: Check for existing PR
        id: check-pr
        if: steps.failure.outputs.skip != 'true'
        env:
          GH_TOKEN: ${{ secrets.MITCHELL_PAT }}
        run: |
          SHORT_SHA="${{ steps.failure.outputs.short_sha }}"

          # Check if PR already exists for this commit
          EXISTING=$(gh pr list -R ${{ github.repository }} --search "CI fix $SHORT_SHA in:title" --json number -q '.[0].number' 2>/dev/null || echo "")

          if [ -n "$EXISTING" ]; then
            echo "PR #$EXISTING already exists for commit $SHORT_SHA"
            echo "skip=true" >> $GITHUB_OUTPUT
          else
            echo "skip=false" >> $GITHUB_OUTPUT
          fi

      - name: Create branch and PR
        id: create-pr
        if: steps.failure.outputs.skip != 'true' && steps.check-pr.outputs.skip != 'true'
        env:
          GH_TOKEN: ${{ secrets.MITCHELL_PAT }}
        run: |
          SHORT_SHA="${{ steps.failure.outputs.short_sha }}"
          FULL_SHA="${{ steps.failure.outputs.sha }}"
          RUN_URL="${{ steps.failure.outputs.run_url }}"

          BRANCH_NAME="copilot/fix-ci-$SHORT_SHA"

          echo "=== Creating fix branch: $BRANCH_NAME ==="

          # Configure git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Create branch from main
          git checkout -b "$BRANCH_NAME"

          # Create a placeholder file to make a commit
          cat > .copilot-fix-request.md << 'EOF'
          # CI Fix Request

          This branch was created to fix CI failure.

          Copilot will make the necessary changes to fix the CI.

          Delete this file after the fix is applied.
          EOF

          git add .copilot-fix-request.md
          git commit -m "ci: request fix for CI failure ($SHORT_SHA)"

          # Push branch
          git push origin "$BRANCH_NAME"

          echo "=== Creating PR ==="

          # Build PR body from failure details JSON
          FAILED_JOBS=$(jq -r '.failedJobs | join(", ")' /tmp/failure-details.json)

          # Create PR body file to avoid escaping issues
          cat > /tmp/pr-body.md << EOF
          ## CI Fix Request

          The CI workflow failed on branch \`main\` at commit \`$FULL_SHA\`.

          **Failed run:** $RUN_URL
          **Failed jobs:** $FAILED_JOBS

          ## Task

          Fix the CI failure by analyzing the logs below and making the necessary code changes.

          **Rules:**
          - Fix the root cause in the source code, tests, or configuration
          - Do NOT skip, disable, or mark any tests as expected failures
          - Do NOT add \`continue-on-error\` or any workaround
          - Delete the \`.copilot-fix-request.md\` file after fixing
          - Keep changes minimal and focused

          ## Failure Logs

          EOF

          # Add job logs from JSON file
          jq -r '.jobLogs[] | "### Job: \(.name)\n\n```\n\(.log)\n```\n"' /tmp/failure-details.json >> /tmp/pr-body.md

          # Create PR
          PR_URL=$(gh pr create \
            -R ${{ github.repository }} \
            --title "[CI Fix] Fix CI failure on main ($SHORT_SHA)" \
            --body-file /tmp/pr-body.md \
            --head "$BRANCH_NAME" \
            --base main)

          PR_NUMBER=$(echo "$PR_URL" | grep -oE '[0-9]+$')
          echo "Created PR #$PR_NUMBER"

          echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT

      - name: Assign Copilot to PR
        if: steps.failure.outputs.skip != 'true' && steps.check-pr.outputs.skip != 'true'
        env:
          GH_TOKEN: ${{ secrets.MITCHELL_PAT }}
        run: |
          PR_NUMBER="${{ steps.create-pr.outputs.pr_number }}"

          if [ -n "$PR_NUMBER" ]; then
            echo "Assigning Copilot to PR #$PR_NUMBER..."
            gh api \
              --method POST \
              -H "Accept: application/vnd.github+json" \
              -H "X-GitHub-Api-Version: 2022-11-28" \
              /repos/${{ github.repository }}/issues/${PR_NUMBER}/assignees \
              -f 'assignees[]=copilot-swe-agent[bot]' || echo "Could not assign Copilot"
            
            echo "âœ… PR #$PR_NUMBER created and assigned to Copilot"
          else
            echo "Could not find PR number"
          fi
