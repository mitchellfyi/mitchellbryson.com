name: Self-Healing CI

on:
  workflow_run:
    workflows: ["CI"]
    branches: [main]
    types: [completed]

permissions:
  issues: write
  actions: read
  checks: read

jobs:
  create-fix-issue:
    name: Create CI Fix Issue
    runs-on: ubuntu-latest
    if: github.event.workflow_run.conclusion == 'failure'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Ensure labels exist
        uses: actions/github-script@v7
        with:
          script: |
            const labels = [
              { name: 'ci-fix', color: 'd73a4a', description: 'Automated CI failure fix request' },
              { name: 'automated', color: '0e8a16', description: 'Created by automation' }
            ];
            for (const label of labels) {
              try {
                await github.rest.issues.getLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  name: label.name
                });
              } catch (error) {
                if (error.status === 404) {
                  await github.rest.issues.createLabel({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    ...label
                  });
                }
              }
            }

      - name: Fetch workflow run details
        id: workflow-details
        uses: actions/github-script@v7
        with:
          script: |
            const runId = context.payload.workflow_run.id;
            const sha = context.payload.workflow_run.head_sha;
            const shortSha = sha.substring(0, 7);
            const jobs = await github.rest.actions.listJobsForWorkflowRun({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: runId
            });
            const failedJobs = jobs.data.jobs.filter(job => job.conclusion === 'failure');
            if (failedJobs.length === 0) return { failedJobs: [], sha, shortSha };
            const jobLogs = [];
            for (const job of failedJobs) {
              try {
                const logs = await github.rest.actions.downloadJobLogsForWorkflowRun({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  job_id: job.id
                });
                const logLines = logs.data.split('\n');
                jobLogs.push({ name: job.name, log: logLines.slice(-200).join('\n') });
              } catch (error) {
                jobLogs.push({ name: job.name, log: 'Failed to fetch logs' });
              }
            }
            return { failedJobs: failedJobs.map(j => j.name), jobLogs, sha, shortSha, runUrl: context.payload.workflow_run.html_url };

      - name: Check for existing ci-fix issue (open OR closed)
        id: check-issue
        uses: actions/github-script@v7
        with:
          script: |
            // Check for ANY issue with ci-fix label (open or closed)
            const openIssues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'ci-fix,automated'
            });
            
            if (openIssues.data.length > 0) {
              const issue = openIssues.data[0];
              const comments = await github.rest.issues.listComments({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number
              });
              const workflowComments = comments.data.filter(c => c.body.includes('## New Failure Detected'));
              return { exists: true, number: issue.number, state: 'open', commentCount: workflowComments.length };
            }
            
            // Check closed issues
            const closedIssues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'closed',
              labels: 'ci-fix,automated',
              sort: 'updated',
              direction: 'desc',
              per_page: 1
            });
            
            if (closedIssues.data.length > 0) {
              const issue = closedIssues.data[0];
              return { exists: true, number: issue.number, state: 'closed', commentCount: 0 };
            }
            
            return { exists: false, number: null, state: null, commentCount: 0 };

      - name: Create or update issue
        id: create-issue
        uses: actions/github-script@v7
        with:
          script: |
            const workflowDetails = ${{ steps.workflow-details.outputs.result }};
            const issueCheck = ${{ steps.check-issue.outputs.result }};
            if (workflowDetails.failedJobs.length === 0) return { issueNumber: null, action: 'none' };
            
            let logsSection = '';
            for (const jobLog of workflowDetails.jobLogs) {
              logsSection += `### Job: ${jobLog.name}\n\n\`\`\`\n${jobLog.log}\n\`\`\`\n\n`;
            }
            
            const repo = context.repo.repo;
            const owner = context.repo.owner;
            
            if (!issueCheck.exists) {
              // Create new issue
              const issueBody = `## CI Failure â€” Auto-generated

            The CI workflow failed on branch \`main\` at commit \`${workflowDetails.sha}\`.

            **Failed run:** ${workflowDetails.runUrl}

            ## Task

            Analyze the failure logs below and fix the code that is causing CI to fail.

            **Rules:**
            - Fix the root cause in the source code, tests, or configuration
            - Do NOT skip, disable, or mark any tests as expected failures
            - Do NOT add \`continue-on-error\` or any other workaround
            - Run the full test suite locally before submitting your PR
            - Keep your changes minimal and focused on the fix
            - **IMPORTANT: Include \`Fixes #ISSUE_NUMBER\` in your PR description** (replace ISSUE_NUMBER with this issue's number)

            ## Failure Logs

            ${logsSection}`;

              const issue = await github.rest.issues.create({
                owner,
                repo,
                title: `[CI Fix] CI failure on \`main\` (${workflowDetails.shortSha})`,
                body: issueBody,
                labels: ['ci-fix', 'automated']
              });
              console.log(`Created issue #${issue.data.number}`);
              return { issueNumber: issue.data.number, action: 'created' };
              
            } else {
              const issueNumber = issueCheck.number;
              
              // If issue is closed, reopen it
              if (issueCheck.state === 'closed') {
                console.log(`Reopening closed issue #${issueNumber}`);
                await github.rest.issues.update({
                  owner,
                  repo,
                  issue_number: issueNumber,
                  state: 'open'
                });
              }
              
              // Check comment count (for max retries)
              if (issueCheck.commentCount >= 3) {
                await github.rest.issues.addLabels({
                  owner,
                  repo,
                  issue_number: issueNumber,
                  labels: ['needs-human']
                });
                console.log(`Max retries reached for issue #${issueNumber}`);
                return { issueNumber, action: 'max-retries' };
              }
              
              // Add new failure comment
              const commentBody = `## New Failure Detected

            **Failed run:** ${workflowDetails.runUrl}
            **Commit:** \`${workflowDetails.sha}\`

            The issue has been reassigned to Copilot for another fix attempt.

            **Remember: Include \`Fixes #${issueNumber}\` in your PR description.**

            ## Failure Logs

            ${logsSection}`;

              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number: issueNumber,
                body: commentBody
              });
              
              // Update title with latest commit
              await github.rest.issues.update({
                owner,
                repo,
                issue_number: issueNumber,
                title: `[CI Fix] CI failure on \`main\` (${workflowDetails.shortSha})`
              });
              
              console.log(`Updated issue #${issueNumber}`);
              return { issueNumber, action: 'updated' };
            }

      - name: Reassign to Copilot
        if: steps.create-issue.outputs.result != '{"issueNumber":null,"action":"none"}' && steps.create-issue.outputs.result != '{"issueNumber":null}'
        env:
          GH_TOKEN: ${{ secrets.MITCHELL_PAT }}
        run: |
          RESULT='${{ steps.create-issue.outputs.result }}'
          ISSUE_NUMBER=$(echo "$RESULT" | jq -r '.issueNumber')
          ACTION=$(echo "$RESULT" | jq -r '.action')
          
          if [ "$ISSUE_NUMBER" != "null" ] && [ -n "$ISSUE_NUMBER" ] && [ "$ACTION" != "max-retries" ]; then
            echo "Processing issue #$ISSUE_NUMBER (action: $ACTION)"
            
            # Remove all current assignees first
            ASSIGNEES=$(gh api /repos/${{ github.repository }}/issues/${ISSUE_NUMBER}/assignees --jq '.[].login' 2>/dev/null | tr '\n' ' ')
            if [ -n "$ASSIGNEES" ]; then
              echo "Removing current assignees: $ASSIGNEES"
              for assignee in $ASSIGNEES; do
                gh api --method DELETE /repos/${{ github.repository }}/issues/${ISSUE_NUMBER}/assignees \
                  -f "assignees[]=$assignee" 2>/dev/null || true
              done
            fi
            
            # Assign to Copilot
            echo "Assigning issue #$ISSUE_NUMBER to Copilot..."
            gh api \
              --method POST \
              -H "Accept: application/vnd.github+json" \
              -H "X-GitHub-Api-Version: 2022-11-28" \
              /repos/${{ github.repository }}/issues/${ISSUE_NUMBER}/assignees \
              -f 'assignees[]=copilot-swe-agent[bot]' || echo "Failed to assign to Copilot"
          fi
