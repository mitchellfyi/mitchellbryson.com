name: Self-Healing CI

on:
  workflow_run:
    workflows: ["CI"]
    types: [completed]
    branches: [main]

permissions:
  issues: write
  actions: read
  checks: read

jobs:
  create-fix-issue:
    name: Create CI Fix Issue
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'failure' }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Ensure labels exist
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        with:
          script: |
            const labels = [
              { name: 'ci-fix', color: 'd73a4a', description: 'Automated CI failure fix request' },
              { name: 'automated', color: '0e8a16', description: 'Created by automation' },
              { name: 'needs-human', color: 'e99695', description: 'Requires human intervention' }
            ];

            for (const label of labels) {
              try {
                await github.rest.issues.getLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  name: label.name
                });
                console.log(`Label ${label.name} already exists`);
              } catch (error) {
                if (error.status === 404) {
                  await github.rest.issues.createLabel({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    name: label.name,
                    color: label.color,
                    description: label.description
                  });
                  console.log(`Created label ${label.name}`);
                }
              }
            }

      - name: Check for existing issue
        id: check-issue
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        with:
          script: |
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: 'ci-fix,automated',
              state: 'open'
            });

            if (issues.data.length > 0) {
              const issue = issues.data[0];
              core.setOutput('exists', 'true');
              core.setOutput('issue_number', issue.number);
              core.setOutput('has_needs_human', issue.labels.some(l => l.name === 'needs-human'));

              // Count existing comments from this workflow
              const comments = await github.rest.issues.listComments({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number
              });

              const botComments = comments.data.filter(c =>
                c.user.login === 'github-actions[bot]' &&
                c.body.includes('## New CI Failure')
              );

              core.setOutput('comment_count', botComments.length);
            } else {
              core.setOutput('exists', 'false');
            }

      - name: Get workflow run jobs
        id: get-jobs
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        with:
          script: |
            const jobs = await github.rest.actions.listJobsForWorkflowRun({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: context.payload.workflow_run.id
            });

            const failedJobs = jobs.data.jobs.filter(job => job.conclusion === 'failure');

            let logsText = '';

            for (const job of failedJobs) {
              logsText += `### Job: ${job.name}\n\n`;

              try {
                const logs = await github.rest.actions.downloadJobLogsForWorkflowRun({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  job_id: job.id
                });

                // Convert logs to text and truncate to last 200 lines
                const logLines = logs.data.split('\n');
                const truncatedLogs = logLines.slice(-200).join('\n');

                logsText += '```\n' + truncatedLogs + '\n```\n\n';
              } catch (error) {
                logsText += `_Failed to fetch logs: ${error.message}_\n\n`;
              }
            }

            if (logsText === '') {
              logsText = '_No failure logs available_';
            }

            // Save to output, escaping for GitHub Actions
            const fs = require('fs');
            const path = require('path');
            const outputFile = path.join(process.env.GITHUB_WORKSPACE || '.', 'failure-logs.txt');
            fs.writeFileSync(outputFile, logsText);
            core.setOutput('logs_file', outputFile);

      - name: Create issue body
        id: create-body
        run: |
          SHA="${{ github.event.workflow_run.head_sha }}"
          SHORT_SHA="${SHA:0:7}"
          RUN_URL="${{ github.event.workflow_run.html_url }}"
          BRANCH="${{ github.event.workflow_run.head_branch }}"

          cat > issue-body.md << 'EOF'
          ## CI Failure — Auto-generated

          The CI workflow failed on branch `$BRANCH` at commit `$SHORT_SHA`.

          **Failed run:** $RUN_URL

          ## Task

          Analyze the failure logs below and fix the code that is causing CI to fail.

          **Rules:**
          - Fix the root cause in the source code, tests, or configuration
          - Do NOT skip, disable, or mark any tests as expected failures
          - Do NOT add `continue-on-error` or any other workaround that masks the failure
          - Run the full test suite locally before submitting your PR
          - Keep your changes minimal and focused on the fix

          ## Failure Logs

          EOF

          # Replace variables in the template
          sed -i "s|\$BRANCH|$BRANCH|g" issue-body.md
          sed -i "s|\$SHORT_SHA|$SHORT_SHA|g" issue-body.md
          sed -i "s|\$RUN_URL|$RUN_URL|g" issue-body.md

          # Append the failure logs
          cat failure-logs.txt >> issue-body.md

          # Set output
          echo "body_file=issue-body.md" >> $GITHUB_OUTPUT

      - name: Create new issue
        if: steps.check-issue.outputs.exists == 'false'
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        with:
          script: |
            const fs = require('fs');
            const body = fs.readFileSync('issue-body.md', 'utf8');
            const sha = '${{ github.event.workflow_run.head_sha }}';
            const shortSha = sha.substring(0, 7);

            try {
              const issue = await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `[CI Fix] Build failure on \`main\` (${shortSha})`,
                body: body,
                labels: ['ci-fix', 'automated'],
                assignees: ['copilot']
              });
              console.log(`Created issue #${issue.data.number}`);
            } catch (error) {
              if (error.message.includes('assignee')) {
                console.log('Warning: Could not assign to copilot user. Creating issue without assignee.');
                const issue = await github.rest.issues.create({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  title: `[CI Fix] Build failure on \`main\` (${shortSha})`,
                  body: body,
                  labels: ['ci-fix', 'automated']
                });
                console.log(`Created issue #${issue.data.number} (no assignee)`);
              } else {
                throw error;
              }
            }

      - name: Add comment to existing issue
        if: |
          steps.check-issue.outputs.exists == 'true' &&
          steps.check-issue.outputs.has_needs_human == 'false' &&
          fromJSON(steps.check-issue.outputs.comment_count) < 3
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        with:
          script: |
            const fs = require('fs');
            const body = fs.readFileSync('issue-body.md', 'utf8');
            const issueNumber = ${{ steps.check-issue.outputs.issue_number }};

            const commentBody = `## New CI Failure\n\n${body}`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: commentBody
            });

            console.log(`Added comment to issue #${issueNumber}`);

      - name: Escalate to needs-human
        if: |
          steps.check-issue.outputs.exists == 'true' &&
          steps.check-issue.outputs.has_needs_human == 'false' &&
          fromJSON(steps.check-issue.outputs.comment_count) >= 3
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        with:
          script: |
            const issueNumber = ${{ steps.check-issue.outputs.issue_number }};

            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              labels: ['needs-human']
            });

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: '⚠️ This issue has failed to resolve after 3 automated attempts. Human intervention is required.'
            });

            console.log(`Escalated issue #${issueNumber} to needs-human`);
