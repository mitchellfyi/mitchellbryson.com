name: Auto-Approve Copilot PRs

on:
  schedule:
    - cron: '*/5 * * * *'
  workflow_dispatch:

permissions:
  pull-requests: write
  actions: write
  contents: read

jobs:
  process-copilot-prs:
    name: Process Copilot PRs
    runs-on: ubuntu-latest
    steps:
      - name: Find and process Copilot PRs
        env:
          GH_TOKEN: ${{ secrets.MITCHELL_PAT }}
        run: |
          echo "Checking for Copilot PRs..."
          
          # Get all open PRs from Copilot
          PRS=$(gh pr list -R ${{ github.repository }} --author "app/copilot-swe-agent" --state open --json number,isDraft,headRefOid,title)
          
          echo "Found PRs: $PRS"
          
          if [ "$PRS" = "[]" ]; then
            echo "No open Copilot PRs found"
            exit 0
          fi
          
          # Process each PR
          echo "$PRS" | jq -c '.[]' | while read -r pr; do
            PR_NUMBER=$(echo "$pr" | jq -r '.number')
            IS_DRAFT=$(echo "$pr" | jq -r '.isDraft')
            HEAD_SHA=$(echo "$pr" | jq -r '.headRefOid')
            TITLE=$(echo "$pr" | jq -r '.title')
            
            echo ""
            echo "=== Processing PR #$PR_NUMBER: $TITLE ==="
            echo "Draft: $IS_DRAFT, SHA: $HEAD_SHA"
            
            # Mark as ready if draft
            if [ "$IS_DRAFT" = "true" ]; then
              echo "Marking PR #$PR_NUMBER as ready for review..."
              gh pr ready "$PR_NUMBER" -R ${{ github.repository }} 2>&1 || echo "Note: Could not mark ready (may still be in progress)"
            fi
            
            # Approve pending workflow runs for this PR's commits
            echo "Checking for workflow runs needing approval..."
            RUNS=$(gh api repos/${{ github.repository }}/actions/runs \
              --jq ".workflow_runs[] | select(.head_sha == \"$HEAD_SHA\" and .status == \"action_required\") | .id" 2>/dev/null || echo "")
            
            if [ -n "$RUNS" ]; then
              for RUN_ID in $RUNS; do
                echo "Approving workflow run $RUN_ID..."
                gh api --method POST \
                  repos/${{ github.repository }}/actions/runs/$RUN_ID/approve 2>/dev/null || echo "Could not approve run $RUN_ID (may not need approval)"
              done
            else
              echo "No workflow runs need approval"
            fi
            
          done
          
          echo ""
          echo "Done processing Copilot PRs"
