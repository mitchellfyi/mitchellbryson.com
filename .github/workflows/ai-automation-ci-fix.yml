name: "AI Automation: CI Fix"

on:
  workflow_run:
    workflows:
      - CI
    types:
      - completed
    branches:
      - main

  # Allow manual trigger for retries
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write
  issues: write
  actions: read
  id-token: write

jobs:
  fix-ci-failure:
    if: |
      github.event_name == 'workflow_dispatch' ||
      github.event.workflow_run.conclusion == 'failure'
    runs-on: ubuntu-latest
    steps:
      - name: Check for existing fix PR or issue
        id: check
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          echo "::group::Checking for existing fix PR or issue"
          REPO="${{ github.repository }}"
          echo "Repository: $REPO"
          
          # For workflow_dispatch, find the latest failed CI run
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "Trigger: workflow_dispatch (manual)"
            FAILED_RUN=$(gh run list --repo "$REPO" --workflow "CI" --branch main --status failure --limit 1 --json databaseId,headSha --jq '.[0] // empty')
            if [ -z "$FAILED_RUN" ]; then
              echo "No failed CI runs found on main - nothing to fix"
              echo "skip=true" >> $GITHUB_OUTPUT
              echo "::endgroup::"
              exit 0
            fi
            FAILED_RUN_ID=$(echo "$FAILED_RUN" | jq -r '.databaseId')
            FAILED_RUN_SHA=$(echo "$FAILED_RUN" | jq -r '.headSha')
            echo "Found failed run: $FAILED_RUN_ID"
            echo "failed_run_id=$FAILED_RUN_ID" >> $GITHUB_OUTPUT
            echo "failed_run_sha=$FAILED_RUN_SHA" >> $GITHUB_OUTPUT
          else
            echo "Trigger: workflow_run (CI failed on main)"
            echo "failed_run_id=${{ github.event.workflow_run.id }}" >> $GITHUB_OUTPUT
            echo "failed_run_sha=${{ github.event.workflow_run.head_sha }}" >> $GITHUB_OUTPUT
          fi
          
          # URL will be printed in failure details step

          # Check for existing PR
          EXISTING_PR=$(gh pr list --repo "$REPO" --label "ai-fix" --state open --json number,title,headRefName --jq '.[0] // empty')
          if [ -n "$EXISTING_PR" ]; then
            echo "Found existing fix PR: $EXISTING_PR"
            echo "Skipping to avoid duplicate fix attempts"
            echo "skip=true" >> $GITHUB_OUTPUT
            echo "::endgroup::"
            exit 0
          fi

          # Check for existing issue (to avoid creating duplicates)
          EXISTING_ISSUE=$(gh issue list --repo "$REPO" --label "ai-fix" --state open --json number,title --jq '.[0] // empty')
          if [ -n "$EXISTING_ISSUE" ]; then
            echo "Found existing fix issue: $EXISTING_ISSUE"
            echo "Skipping to avoid duplicate fix attempts"
            echo "skip=true" >> $GITHUB_OUTPUT
            echo "::endgroup::"
            exit 0
          fi

          echo "No existing fix PR or issue found - will create one"
          echo "skip=false" >> $GITHUB_OUTPUT
          echo "::endgroup::"

      - name: Get failure details
        if: steps.check.outputs.skip != 'true'
        id: failure
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          echo "::group::Getting failure details"
          RUN_ID="${{ steps.check.outputs.failed_run_id || github.event.workflow_run.id }}"
          REPO="${{ github.repository }}"

          echo "Fetching job details for run $RUN_ID..."
          JOBS_JSON=$(gh api repos/$REPO/actions/runs/$RUN_ID/jobs)
          FAILED_JOBS=$(echo "$JOBS_JSON" | jq -r '[.jobs[] | select(.conclusion == "failure") | .name] | join(", ")' || echo "Unknown")
          echo "Failed jobs: $FAILED_JOBS"

          FAILED_STEPS=$(echo "$JOBS_JSON" | jq -r '[.jobs[] | select(.conclusion == "failure") | .steps[] | select(.conclusion == "failure") | .name] | join(", ")' 2>/dev/null || echo "Unknown")
          echo "Failed steps: $FAILED_STEPS"

          echo "Fetching error logs..."
          ERROR_LOGS=$(gh run view $RUN_ID --repo $REPO --log-failed 2>/dev/null | tail -200 | head -c 8000 || echo "Could not fetch logs")
          LOG_LENGTH=${#ERROR_LOGS}
          echo "Captured $LOG_LENGTH chars of error logs"

          # Get commit SHA for this run
          COMMIT_SHA=$(gh api repos/$REPO/actions/runs/$RUN_ID --jq '.head_sha' 2>/dev/null || echo "unknown")
          
          echo "run_id=$RUN_ID" >> $GITHUB_OUTPUT
          echo "failed_jobs=$FAILED_JOBS" >> $GITHUB_OUTPUT
          echo "failed_steps=$FAILED_STEPS" >> $GITHUB_OUTPUT
          echo "run_url=https://github.com/$REPO/actions/runs/$RUN_ID" >> $GITHUB_OUTPUT
          echo "commit_sha=$COMMIT_SHA" >> $GITHUB_OUTPUT

          echo "$ERROR_LOGS" > /tmp/error_logs.txt
          echo "::endgroup::"

      - name: Checkout
        if: steps.check.outputs.skip != 'true'
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_PAT }}
          fetch-depth: 0

      - name: Create fix branch
        if: steps.check.outputs.skip != 'true'
        id: branch
        run: |
          echo "::group::Creating fix branch"
          BRANCH_NAME="ai/fix-ci-$(date +%Y%m%d-%H%M%S)"
          git checkout -b "$BRANCH_NAME"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git commit --allow-empty -m "fix: CI failures (in progress)"
          git push -u origin "$BRANCH_NAME"

          echo "Created and pushed branch: $BRANCH_NAME"
          echo "Base commit: $(git rev-parse HEAD~1)"
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT
          echo "::endgroup::"

      - name: Ensure labels exist
        if: steps.check.outputs.skip != 'true'
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          REPO="${{ github.repository }}"
          gh label create "ai-fix" --repo "$REPO" --description "Automated CI fix by AI" --color "7057ff" 2>/dev/null || true
          gh label create "automation" --repo "$REPO" --description "Automated workflow" --color "ededed" 2>/dev/null || true
          gh label create "ci" --repo "$REPO" --description "CI/CD related" --color "fbca04" 2>/dev/null || true
          gh label create "needs-human" --repo "$REPO" --description "Automated fix failed — needs human intervention" --color "d73a4a" 2>/dev/null || true

      - name: Create tracking issue
        if: steps.check.outputs.skip != 'true'
        id: issue
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          echo "::group::Creating tracking issue"
          REPO="${{ github.repository }}"
          RUN_URL="${{ steps.failure.outputs.run_url }}"
          FAILED_JOBS="${{ steps.failure.outputs.failed_jobs }}"
          FAILED_STEPS="${{ steps.failure.outputs.failed_steps }}"
          ERROR_LOGS=$(cat /tmp/error_logs.txt)

          {
            echo "CI failed on \`main\`. Attempting automatic fix."
            echo ""
            echo "## Details"
            echo "- **Failed Run:** $RUN_URL"
            echo "- **Failed Jobs:** $FAILED_JOBS"
            echo "- **Failed Steps:** $FAILED_STEPS"
            echo "- **Commit:** \`${{ steps.failure.outputs.commit_sha }}\`"
            echo ""
            echo "## Error Logs"
            echo ""
            echo '<details>'
            echo '<summary>Click to expand full error output</summary>'
            echo ""
            echo '```'
            echo "$ERROR_LOGS"
            echo '```'
            echo ""
            echo '</details>'
            echo ""
            echo "---"
            echo "This issue will be auto-closed when the fix PR merges."
          } > /tmp/issue_body.md

          echo "Creating issue..."
          ISSUE_URL=$(gh issue create \
            --repo "$REPO" \
            --title "CI Fix: $FAILED_JOBS failure" \
            --body-file /tmp/issue_body.md \
            --label "automation,ci,ai-fix")

          ISSUE_NUM=$(echo "$ISSUE_URL" | grep -oE '[0-9]+$')
          echo "Created issue #$ISSUE_NUM: $ISSUE_URL"
          echo "issue_number=$ISSUE_NUM" >> $GITHUB_OUTPUT
          echo "::endgroup::"

      - name: Create draft PR
        if: steps.check.outputs.skip != 'true'
        id: pr
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          echo "::group::Creating draft PR"
          REPO="${{ github.repository }}"
          BRANCH="${{ steps.branch.outputs.branch_name }}"
          ISSUE_NUM="${{ steps.issue.outputs.issue_number }}"
          RUN_URL="${{ steps.failure.outputs.run_url }}"
          FAILED_JOBS="${{ steps.failure.outputs.failed_jobs }}"
          FAILED_STEPS="${{ steps.failure.outputs.failed_steps }}"
          ERROR_LOGS=$(cat /tmp/error_logs.txt)

          {
            echo "## CI Fix (In Progress)"
            echo ""
            echo "Automated fix for CI failures. PR is in draft while the AI agent works."
            echo ""
            echo "### Original Failure"
            echo "- **Failed Run:** $RUN_URL"
            echo "- **Failed Jobs:** $FAILED_JOBS"
            echo "- **Failed Steps:** $FAILED_STEPS"
            echo ""
            echo "### Error Logs"
            echo ""
            echo '<details>'
            echo '<summary>Click to expand full error output</summary>'
            echo ""
            echo '```'
            echo "$ERROR_LOGS"
            echo '```'
            echo ""
            echo '</details>'
            echo ""
            echo "Fixes #$ISSUE_NUM"
            echo ""
            echo "---"
            echo "_Generated with [Claude Code](https://claude.ai/code)_"
          } > /tmp/pr_body.md

          echo "Creating draft PR..."
          PR_URL=$(gh pr create \
            --repo "$REPO" \
            --head "$BRANCH" \
            --base main \
            --title "fix: CI failures ($FAILED_JOBS)" \
            --body-file /tmp/pr_body.md \
            --label "ai-fix" \
            --draft)

          PR_NUM=$(echo "$PR_URL" | grep -oE '[0-9]+$')
          echo "Created draft PR #$PR_NUM: $PR_URL"
          echo "pr_number=$PR_NUM" >> $GITHUB_OUTPUT
          echo "::endgroup::"

      - name: Build prompt
        if: steps.check.outputs.skip != 'true'
        id: build-prompt
        run: |
          DELIM="PROMPT_EOF_$(date +%s)"
          {
            echo "content<<$DELIM"
            echo "CI has failed on the main branch. You are on branch \`${{ steps.branch.outputs.branch_name }}\`."
            echo "A draft PR #${{ steps.pr.outputs.pr_number }} has been created for your fixes."
            echo ""
            echo "Your task is to diagnose and fix the CI failures."
            echo ""
            echo "## Failure Context"
            echo "- **Failed jobs:** ${{ steps.failure.outputs.failed_jobs }}"
            echo "- **Failed steps:** ${{ steps.failure.outputs.failed_steps }}"
            echo "- **Run URL:** ${{ steps.failure.outputs.run_url }}"
            echo ""
            echo "## Error Logs"
            echo '```'
            cat /tmp/error_logs.txt
            echo '```'
            echo ""
            cat .github/ai-automation/prompts/ci-fix.md
            echo ""
            echo "Do NOT create a new PR - one already exists (#${{ steps.pr.outputs.pr_number }})."
            echo "$DELIM"
          } >> $GITHUB_OUTPUT

      - name: Fix CI with Claude
        if: steps.check.outputs.skip != 'true'
        id: claude
        continue-on-error: true
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          show_full_output: true
          prompt: ${{ steps.build-prompt.outputs.content }}
          claude_args: "--max-turns 50 --allowedTools 'Bash(*),Read(*),Write(*),Edit(*),MultiEdit(*),Glob(*),Grep(*),GitHub(*)'"

      - name: Mark PR ready for review
        if: steps.check.outputs.skip != 'true'
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          echo "::group::Marking PR ready for review"
          REPO="${{ github.repository }}"
          PR_NUM="${{ steps.pr.outputs.pr_number }}"
          BRANCH="${{ steps.branch.outputs.branch_name }}"
          ISSUE_NUM="${{ steps.issue.outputs.issue_number }}"
          RUN_URL="${{ steps.failure.outputs.run_url }}"
          FAILED_JOBS="${{ steps.failure.outputs.failed_jobs }}"
          FAILED_STEPS="${{ steps.failure.outputs.failed_steps }}"
          ERROR_LOGS=$(cat /tmp/error_logs.txt)
          CLAUDE_OUTCOME="${{ steps.claude.outcome }}"

          # Configure git auth (token from checkout may be lost after claude-code-action)
          git remote set-url origin "https://x-access-token:${GH_TOKEN}@github.com/${{ github.repository }}.git"

          # Push any unpushed commits
          UNPUSHED=$(git rev-list --count origin/$BRANCH..HEAD 2>/dev/null || echo "0")
          if [ "$UNPUSHED" -gt 0 ]; then
            echo "Pushing $UNPUSHED unpushed commits..."
            git push
          fi

          COMMIT_COUNT=$(git rev-list --count origin/main..HEAD)
          CHANGED_FILES=$(git diff --name-only origin/main..HEAD | head -20)
          REAL_COMMITS=$((COMMIT_COUNT - 1))
          echo "Claude outcome: $CLAUDE_OUTCOME"
          echo "Fix commits: $REAL_COMMITS"
          echo "Changed files:"
          echo "$CHANGED_FILES"

          # Capture Claude error details if failed
          CLAUDE_ERROR_SECTION=""
          if [ "$CLAUDE_OUTCOME" = "failure" ]; then
            echo "Capturing Claude error details..."
            EXEC_FILE="${{ steps.claude.outputs.execution_file }}"
            if [ -f "$EXEC_FILE" ]; then
              ERRORS=$(jq -r '.errors // [] | .[]' "$EXEC_FILE" 2>/dev/null || echo "")
              LAST_OUTPUT=$(jq -r '.messages[-3:] | .[] | select(.role == "assistant") | .content[0].text // empty' "$EXEC_FILE" 2>/dev/null | tail -500 || echo "")
              
              CLAUDE_ERROR_SECTION="
### ⚠️ Claude Execution Failed

<details>
<summary>Error details (click to expand)</summary>

**Errors:** ${ERRORS:-None captured}

**Last output:**
\`\`\`
${LAST_OUTPUT:-No output captured}
\`\`\`

</details>
"
            fi
          fi

          # Update PR body
          {
            echo "## CI Fix"
            echo ""
            if [ "$REAL_COMMITS" -gt 0 ]; then
              echo "Automated fix for CI failures on \`main\`."
            elif [ "$CLAUDE_OUTCOME" = "failure" ]; then
              echo "Automated fix attempt failed. Claude encountered an error. Awaiting retry."
              echo "$CLAUDE_ERROR_SECTION"
            else
              echo "Automated fix attempt for CI failures on \`main\`. No changes made yet — awaiting retry."
            fi
            echo ""
            echo "### Original Failure"
            echo "- **Failed Run:** $RUN_URL"
            echo "- **Failed Jobs:** $FAILED_JOBS"
            echo "- **Failed Steps:** $FAILED_STEPS"
            echo ""
            echo "### Error Logs"
            echo ""
            echo '<details>'
            echo '<summary>Click to expand full error output</summary>'
            echo ""
            echo '```'
            echo "$ERROR_LOGS"
            echo '```'
            echo ""
            echo '</details>'
            if [ "$REAL_COMMITS" -gt 0 ]; then
              echo ""
              echo "### Changes"
              echo "- **Commits:** $REAL_COMMITS"
              echo '```'
              echo "$CHANGED_FILES"
              echo '```'
            fi
            echo ""
            echo "Fixes #$ISSUE_NUM"
            echo ""
            echo "---"
            echo "_Generated with [Claude Code](https://claude.ai/code)_"
          } > /tmp/pr_body_done.md

          gh pr edit $PR_NUM --repo "$REPO" --body-file /tmp/pr_body_done.md

          # Always mark ready — CI will run and the retry loop handles failures
          gh pr ready $PR_NUM --repo "$REPO"
          echo "PR #$PR_NUM marked ready for review"
          echo "::endgroup::"
