name: "AI Automation: Code Review"

on:
  workflow_run:
    workflows:
      - CI
    types:
      - completed

concurrency:
  group: code-review-${{ github.event.workflow_run.head_branch }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write
  issues: read
  actions: read
  id-token: write

jobs:
  review:
    if: github.event.workflow_run.conclusion == 'success'
    runs-on: ubuntu-latest
    steps:
      - name: Find PR for this CI run
        id: find-pr
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          echo "::group::Finding PR"
          REPO="${{ github.repository }}"
          # Note: workflow_run.head_branch is unreliable (often shows 'main')
          # Use head_sha to find the actual PR
          SHA="${{ github.event.workflow_run.head_sha }}"
          RUN_ID="${{ github.event.workflow_run.id }}"

          echo "CI run: $RUN_ID (commit: ${SHA:0:7})"

          # Find PR associated with this commit using the GitHub API
          PR_JSON=$(gh api "repos/$REPO/commits/$SHA/pulls" --jq '.[0] // empty' 2>/dev/null || echo "")
          
          if [ -z "$PR_JSON" ] || [ "$PR_JSON" = "null" ]; then
            # Fallback: check if this was a push to main (no PR)
            echo "No PR found for commit ${SHA:0:7} - likely a direct push to main"
            echo "skip=true" >> $GITHUB_OUTPUT
            echo "::endgroup::"
            exit 0
          fi
          
          PR_NUM=$(echo "$PR_JSON" | jq -r '.number')
          PR_STATE=$(echo "$PR_JSON" | jq -r '.state')
          IS_DRAFT=$(echo "$PR_JSON" | jq -r '.draft')
          PR_TITLE=$(echo "$PR_JSON" | jq -r '.title')
          PR_BRANCH=$(echo "$PR_JSON" | jq -r '.head.ref')
          
          echo "Found PR #$PR_NUM: $PR_TITLE (branch: $PR_BRANCH)"
          
          if [ "$PR_STATE" != "open" ]; then
            echo "PR #$PR_NUM is $PR_STATE - skipping"
            echo "skip=true" >> $GITHUB_OUTPUT
            echo "::endgroup::"
            exit 0
          fi

          if [ "$IS_DRAFT" = "true" ]; then
            echo "PR #$PR_NUM is draft - skipping review"
            echo "skip=true" >> $GITHUB_OUTPUT
            echo "::endgroup::"
            exit 0
          fi

          # Check if already reviewed this commit (avoid duplicate reviews)
          EXISTING=$(gh api "repos/$REPO/pulls/$PR_NUM/reviews" --jq "[.[] | select(.commit_id == \"$SHA\" and .state != \"PENDING\" and .state != \"DISMISSED\")] | length" 2>/dev/null || echo "0")
          if [ "$EXISTING" -gt 0 ]; then
            echo "Already reviewed commit ${SHA:0:7} on PR #$PR_NUM - skipping"
            echo "skip=true" >> $GITHUB_OUTPUT
            echo "::endgroup::"
            exit 0
          fi

          echo "Will review PR #$PR_NUM: $PR_TITLE"
          echo "skip=false" >> $GITHUB_OUTPUT
          echo "pr_number=$PR_NUM" >> $GITHUB_OUTPUT
          echo "::endgroup::"

      - name: Checkout
        if: steps.find-pr.outputs.skip != 'true'
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_branch }}
          token: ${{ secrets.GH_PAT }}
          fetch-depth: 0

      - name: Build prompt
        if: steps.find-pr.outputs.skip != 'true'
        id: build-prompt
        env:
          PR_NUMBER: ${{ steps.find-pr.outputs.pr_number }}
          COMMIT_SHA: ${{ github.event.workflow_run.head_sha }}
          REPO: ${{ github.repository }}
        run: |
          DELIM="PROMPT_EOF_$(date +%s)"
          {
            echo "content<<$DELIM"
            cat .github/ai-automation/prompts/code-review.md
            echo ""
            echo "## Review Target"
            echo "- PR number: $PR_NUMBER"
            echo "- Commit SHA: $COMMIT_SHA"
            echo "- Repository: $REPO"
            echo ""
            echo "Review PR #$PR_NUMBER now."
            echo "$DELIM"
          } >> $GITHUB_OUTPUT

      - name: Review with Claude
        if: steps.find-pr.outputs.skip != 'true'
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          show_full_output: true
          prompt: ${{ steps.build-prompt.outputs.content }}
          claude_args: "--max-turns 200 --allowedTools 'Bash(*),Read(*),Glob(*),Grep(*),GitHub(*)'"
