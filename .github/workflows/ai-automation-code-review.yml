name: "AI Automation: Code Review"

on:
  # Trigger when PR is marked ready for review
  pull_request:
    types: [ready_for_review]

  # Trigger when CI completes (for PRs that were already ready)
  workflow_run:
    workflows:
      - CI
    types:
      - completed

  # Allow manual trigger
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR number to review'
        required: true
        type: number

concurrency:
  group: code-review-${{ github.event.pull_request.number || github.event.inputs.pr_number || github.event.workflow_run.id }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write
  issues: read
  actions: read
  id-token: write

jobs:
  review:
    # Skip if workflow_run failed (for workflow_run trigger)
    if: |
      github.event_name == 'pull_request' ||
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success')
    runs-on: ubuntu-latest
    steps:
      - name: Find PR to review
        id: find-pr
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          echo "::group::Finding PR"
          REPO="${{ github.repository }}"
          
          # Determine PR number based on trigger type
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            PR_NUM="${{ github.event.pull_request.number }}"
            echo "Trigger: pull_request (ready_for_review)"
          elif [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            PR_NUM="${{ github.event.inputs.pr_number }}"
            echo "Trigger: workflow_dispatch"
          else
            # workflow_run trigger - find PR by scanning open PRs
            echo "Trigger: workflow_run (CI completed)"
            RUN_ID="${{ github.event.workflow_run.id }}"
            echo "CI run: $RUN_ID"
            
            # Get the branch from the CI run
            CI_BRANCH="${{ github.event.workflow_run.head_branch }}"
            echo "CI branch: $CI_BRANCH"
            
            # Skip if CI was on main (no PR to review)
            if [ "$CI_BRANCH" = "main" ] || [ "$CI_BRANCH" = "master" ]; then
              echo "CI ran on default branch - no PR to review"
              echo "skip=true" >> $GITHUB_OUTPUT
              echo "::endgroup::"
              exit 0
            fi
            
            # Find PR for this branch
            PR_JSON=$(gh pr list --repo "$REPO" --head "$CI_BRANCH" --state open --json number,draft --jq '.[0] // empty' 2>/dev/null)
            
            if [ -z "$PR_JSON" ] || [ "$PR_JSON" = "null" ]; then
              echo "No open PR found for branch $CI_BRANCH"
              echo "skip=true" >> $GITHUB_OUTPUT
              echo "::endgroup::"
              exit 0
            fi
            
            PR_NUM=$(echo "$PR_JSON" | jq -r '.number')
          fi
          
          echo "PR number: $PR_NUM"
          
          # Get full PR details
          PR_JSON=$(gh pr view "$PR_NUM" --repo "$REPO" --json number,state,isDraft,title,headRefName,headRefOid)
          PR_STATE=$(echo "$PR_JSON" | jq -r '.state')
          IS_DRAFT=$(echo "$PR_JSON" | jq -r '.isDraft')
          PR_TITLE=$(echo "$PR_JSON" | jq -r '.title')
          PR_BRANCH=$(echo "$PR_JSON" | jq -r '.headRefName')
          PR_SHA=$(echo "$PR_JSON" | jq -r '.headRefOid')
          
          echo "PR #$PR_NUM: $PR_TITLE"
          echo "Branch: $PR_BRANCH"
          echo "SHA: ${PR_SHA:0:7}"
          echo "State: $PR_STATE"
          echo "Draft: $IS_DRAFT"
          
          if [ "$PR_STATE" != "OPEN" ]; then
            echo "PR #$PR_NUM is $PR_STATE - skipping"
            echo "skip=true" >> $GITHUB_OUTPUT
            echo "::endgroup::"
            exit 0
          fi

          if [ "$IS_DRAFT" = "true" ]; then
            echo "PR #$PR_NUM is draft - skipping review"
            echo "skip=true" >> $GITHUB_OUTPUT
            echo "::endgroup::"
            exit 0
          fi
          
          # Check CI status for this PR
          CI_STATUS=$(gh pr checks "$PR_NUM" --repo "$REPO" --json name,state --jq '[.[] | select(.name | test("^(code-review|check-auto-merge|handle-review-comments|fix-pr-ci-failure|mark-pr-ready)$") | not)] | if length == 0 then "pending" elif all(.state == "SUCCESS" or .state == "SKIPPED") then "pass" elif any(.state == "FAILURE") then "fail" else "pending" end' 2>/dev/null || echo "unknown")
          echo "CI status: $CI_STATUS"
          
          if [ "$CI_STATUS" != "pass" ]; then
            echo "CI not passing - skipping review"
            echo "skip=true" >> $GITHUB_OUTPUT
            echo "::endgroup::"
            exit 0
          fi

          # Check if already APPROVED (avoid duplicate approvals)
          # We only skip if there's an APPROVED review - COMMENTED reviews don't count
          APPROVED=$(gh api "repos/$REPO/pulls/$PR_NUM/reviews" --jq "[.[] | select(.commit_id == \"$PR_SHA\" and .state == \"APPROVED\")] | length" 2>/dev/null || echo "0")
          if [ "$APPROVED" -gt 0 ]; then
            echo "Already approved on commit ${PR_SHA:0:7} - skipping"
            echo "skip=true" >> $GITHUB_OUTPUT
            echo "::endgroup::"
            exit 0
          fi

          echo "Will review PR #$PR_NUM: $PR_TITLE"
          echo "skip=false" >> $GITHUB_OUTPUT
          echo "pr_number=$PR_NUM" >> $GITHUB_OUTPUT
          echo "pr_branch=$PR_BRANCH" >> $GITHUB_OUTPUT
          echo "pr_sha=$PR_SHA" >> $GITHUB_OUTPUT
          echo "::endgroup::"

      - name: Checkout
        if: steps.find-pr.outputs.skip != 'true'
        uses: actions/checkout@v6
        with:
          ref: ${{ steps.find-pr.outputs.pr_branch }}
          token: ${{ secrets.GH_PAT }}
          fetch-depth: 0

      - name: Build prompt
        if: steps.find-pr.outputs.skip != 'true'
        id: build-prompt
        env:
          PR_NUMBER: ${{ steps.find-pr.outputs.pr_number }}
          COMMIT_SHA: ${{ steps.find-pr.outputs.pr_sha }}
          REPO: ${{ github.repository }}
        run: |
          DELIM="PROMPT_EOF_$(date +%s)"
          {
            echo "content<<$DELIM"
            cat .github/ai-automation/prompts/code-review.md
            echo ""
            echo "## Review Target"
            echo "- PR number: $PR_NUMBER"
            echo "- Commit SHA: $COMMIT_SHA"
            echo "- Repository: $REPO"
            echo ""
            echo "Review PR #$PR_NUMBER now."
            echo "$DELIM"
          } >> $GITHUB_OUTPUT

      - name: Review with Claude
        if: steps.find-pr.outputs.skip != 'true'
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ secrets.GH_PAT }}
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          show_full_output: true
          prompt: ${{ steps.build-prompt.outputs.content }}
          claude_args: "--model claude-opus-4-20250514 --max-turns 200 --allowedTools 'Bash(*),Read(*),Glob(*),Grep(*),GitHub(*)'"
