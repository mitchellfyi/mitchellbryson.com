name: Rollback Production

on:
  workflow_dispatch:
    inputs:
      commit_sha:
        description: 'Commit SHA to rollback to (must exist on main)'
        required: true
        type: string

concurrency:
  group: deploy-production
  cancel-in-progress: true

jobs:
  rollback:
    name: Rollback
    runs-on: ubuntu-latest
    permissions:
      contents: read
    environment: production
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1
        with:
          ref: ${{ inputs.commit_sha }}

      - name: Verify commit exists on main
        run: |
          git fetch origin main --depth=100
          if ! git merge-base --is-ancestor "${{ inputs.commit_sha }}" origin/main; then
            echo "::error::Commit ${{ inputs.commit_sha }} is not on the main branch"
            exit 1
          fi

      - name: Setup Node
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        with:
          node-version: 22
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build
        run: npm run build

      - name: Rollback summary
        run: |
          echo "## Rollback Summary" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "| Field | Value |" >> "$GITHUB_STEP_SUMMARY"
          echo "|-------|-------|" >> "$GITHUB_STEP_SUMMARY"
          echo "| **Target Commit** | \`${{ inputs.commit_sha }}\` |" >> "$GITHUB_STEP_SUMMARY"
          echo "| **Environment** | production |" >> "$GITHUB_STEP_SUMMARY"
          echo "| **Triggered by** | ${{ github.actor }} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| **Timestamp** | $(date -u +'%Y-%m-%dT%H:%M:%SZ') |" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "> To complete the rollback, redeploy this commit via Vercel:" >> "$GITHUB_STEP_SUMMARY"
          echo "> \`vercel --prod --yes\` from this checkout, or use the Vercel dashboard." >> "$GITHUB_STEP_SUMMARY"
